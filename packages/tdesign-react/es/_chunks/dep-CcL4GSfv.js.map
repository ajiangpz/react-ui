{"version":3,"file":"dep-CcL4GSfv.js","sources":["../../../components/form/hooks/useForm.ts"],"sourcesContent":["import { useState, useRef } from 'react';\nimport type { NamePath } from '../type';\nimport type {\n  WatchCallBack,\n  InternalHooks,\n  InternalFormInstance,\n  Store,\n} from './interface';\n\nexport const HOOK_MARK = 'TD_FORM_INTERNAL_HOOKS';\n\n// TODO 后续将所有实例函数迁移到 FormStore 内统一管理\nclass FormStore {\n  private prevStore: Store = {};\n\n  private store: Store = {};\n\n  private forceRootUpdate: () => void;\n\n  constructor(forceReRender) {\n    this.forceRootUpdate = forceReRender;\n  }\n\n  public taskQueue: any[] = [];\n\n  public flashQueue = () => {\n    this.taskQueue.forEach((task) => {\n      this[task.name].apply(this, [...task.args]);\n    });\n    this.taskQueue = [];\n  };\n\n  public getForm = (): InternalFormInstance => ({\n    submit: (...args) => {\n      this.taskQueue.push({ args, name: 'submit' });\n    },\n    reset: (...args) => {\n      this.taskQueue.push({ args, name: 'reset' });\n    },\n    validate: null,\n    validateOnly: null,\n    clearValidate: (...args) => {\n      this.taskQueue.push({ args, name: 'clearValidate' });\n    },\n    setFields: (...args) => {\n      this.taskQueue.push({ args, name: 'setFields' });\n    },\n    setFieldsValue: (...args) => {\n      this.taskQueue.push({ args, name: 'setFieldsValue' });\n    },\n    setValidateMessage: (...args) => {\n      this.taskQueue.push({ args, name: 'setValidateMessage' });\n    },\n    getValidateMessage: (...args) => {\n      this.taskQueue.push({ args, name: 'getValidateMessage' });\n    },\n    getFieldValue: null,\n    getFieldsValue: null,\n    _init: true,\n    store: this.store,\n    getInternalHooks: this.getInternalHooks,\n  });\n\n  private getInternalHooks = (key: string): InternalHooks | null => {\n    if (key === HOOK_MARK) {\n      return {\n        setForm: (formInstance) => {\n          Object.keys(formInstance).forEach((key) => {\n            this[key] = formInstance[key];\n          });\n        },\n        flashQueue: this.flashQueue,\n        notifyWatch: this.notifyWatch,\n        registerWatch: this.registerWatch,\n        getPrevStore: () => this.prevStore,\n        setPrevStore: (store: object) => {\n          this.prevStore = store;\n        },\n      };\n    }\n\n    console.warn(\n      'Form',\n      '`getInternalHooks` is internal usage. Should not call directly.',\n    );\n    return null;\n  };\n\n  private watchList: WatchCallBack[] = [];\n\n  private registerWatch: InternalHooks['registerWatch'] = (callback) => {\n    this.watchList.push(callback);\n\n    return () => {\n      this.watchList = this.watchList.filter((fn) => fn !== callback);\n    };\n  };\n\n  private notifyWatch = (namePath: NamePath = []) => {\n    // No need to cost perf when nothing need to watch\n    if (this.watchList.length) {\n      // @ts-ignore\n      const values = this.getFieldsValue?.([namePath]);\n\n      this.watchList.forEach((callback) => {\n        callback(values, namePath);\n      });\n    }\n  };\n}\n\nexport default function useForm(form?: InternalFormInstance) {\n  const formRef = useRef<InternalFormInstance>(Object.create({}));\n  const [, forceUpdate] = useState({});\n\n  // eslint-disable-next-line\n  if (!formRef.current._init) {\n    if (form) {\n      formRef.current = form;\n      // Reset store when reopening\n      formRef.current.store = {};\n    } else {\n      // Create a new FormStore if not provided\n      const forceReRender = () => {\n        forceUpdate({});\n      };\n\n      const formStore: FormStore = new FormStore(forceReRender);\n\n      formRef.current = formStore.getForm();\n    }\n  }\n\n  return [formRef.current];\n}\n"],"names":["HOOK_MARK","FormStore","_createClass","forceReRender","_this","_classCallCheck","_defineProperty","taskQueue","forEach","task","name","apply","args","submit","_len","arguments","length","Array","_key","push","reset","_len2","_key2","validate","validateOnly","clearValidate","_len3","_key3","setFields","_len4","_key4","setFieldsValue","_len5","_key5","setValidateMessage","_len6","_key6","getValidateMessage","_len7","_key7","getFieldValue","getFieldsValue","_init","store","getInternalHooks","key","setForm","formInstance","Object","keys","flashQueue","notifyWatch","registerWatch","getPrevStore","prevStore","setPrevStore","console","warn","callback","watchList","filter","fn","namePath","undefined","_this$getFieldsValue","values","call","forceRootUpdate","useForm","form","formRef","useRef","create","_useState","useState","_useState2","_slicedToArray","forceUpdate","current","formStore","getForm"],"mappings":";;;;;;;AASO,IAAMA,SAAA,GAAY;AAAA,IAGnBC,SAAA,gBAAAC,YAAA,CAOJ,SAAAD,SAAAA,CAAYE,aAAA,EAAe;AAAA,EAAA,IAAAC,KAAA,GAAA,IAAA;AAAAC,EAAAA,eAAA,OAAAJ,SAAA,CAAA;EAAAK,eAAA,CAAA,IAAA,EAAA,WAAA,EANA,EAAC,CAAA;EAAAA,eAAA,CAAA,IAAA,EAAA,OAAA,EAEL,EAAC,CAAA;AAAAA,EAAAA,eAAA,oBAQE,EAAC,CAAA;AAAAA,EAAAA,eAAA,qBAEP,YAAM;AACxBF,IAAAA,KAAA,CAAKG,SAAA,CAAUC,OAAA,CAAQ,UAACC,IAAA,EAAS;AAC/BL,MAAAA,KAAA,CAAKK,IAAA,CAAKC,IAAI,CAAA,CAAEC,KAAA,CAAMP,0BAAUK,IAAA,CAAKG,IAAI,CAAC,CAAA;AAC5C,IAAA,CAAC,CAAA;IACDR,KAAA,CAAKG,YAAY,EAAC;EACpB,CAAA,CAAA;AAAAD,EAAAA,eAAA,CAAA,IAAA,EAAA,SAAA,EAEiB,YAAA;IAAA,OAA6B;AAC5CO,MAAAA,MAAA,EAAQ,SAARA,MAAAA,GAAqB;AAAA,QAAA,KAAA,IAAAC,IAAA,GAAAC,SAAA,CAAAC,MAAA,EAATJ,IAAA,GAAA,IAAAK,KAAA,CAAAH,IAAA,GAAAI,IAAA,GAAA,CAAA,EAAAA,IAAA,GAAAJ,IAAA,EAAAI,IAAA,EAAA,EAAA;AAAAN,UAAAA,IAAA,CAAAM,IAAA,CAAA,GAAAH,SAAA,CAAAG,IAAA,CAAA;AAAA,QAAA;AACVd,QAAAA,KAAA,CAAKG,UAAUY,IAAA,CAAK;AAAEP,UAAAA,IAAA,EAAAA,IAAA;AAAMF,UAAAA,IAAA,EAAM;AAAS,SAAC,CAAA;MAC9C,CAAA;AACAU,MAAAA,KAAA,EAAO,SAAPA,KAAAA,GAAoB;AAAA,QAAA,KAAA,IAAAC,KAAA,GAAAN,SAAA,CAAAC,MAAA,EAATJ,IAAA,GAAA,IAAAK,KAAA,CAAAI,KAAA,GAAAC,KAAA,GAAA,CAAA,EAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA,EAAA,EAAA;AAAAV,UAAAA,IAAA,CAAAU,KAAA,CAAA,GAAAP,SAAA,CAAAO,KAAA,CAAA;AAAA,QAAA;AACTlB,QAAAA,KAAA,CAAKG,UAAUY,IAAA,CAAK;AAAEP,UAAAA,IAAA,EAAAA,IAAA;AAAMF,UAAAA,IAAA,EAAM;AAAQ,SAAC,CAAA;MAC7C,CAAA;AACAa,MAAAA,QAAA,EAAU,IAAA;AACVC,MAAAA,YAAA,EAAc,IAAA;AACdC,MAAAA,aAAA,EAAe,SAAfA,aAAAA,GAA4B;AAAA,QAAA,KAAA,IAAAC,KAAA,GAAAX,SAAA,CAAAC,MAAA,EAATJ,IAAA,GAAA,IAAAK,KAAA,CAAAS,KAAA,GAAAC,KAAA,GAAA,CAAA,EAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA,EAAA,EAAA;AAAAf,UAAAA,IAAA,CAAAe,KAAA,CAAA,GAAAZ,SAAA,CAAAY,KAAA,CAAA;AAAA,QAAA;AACjBvB,QAAAA,KAAA,CAAKG,UAAUY,IAAA,CAAK;AAAEP,UAAAA,IAAA,EAAAA,IAAA;AAAMF,UAAAA,IAAA,EAAM;AAAgB,SAAC,CAAA;MACrD,CAAA;AACAkB,MAAAA,SAAA,EAAW,SAAXA,SAAAA,GAAwB;AAAA,QAAA,KAAA,IAAAC,KAAA,GAAAd,SAAA,CAAAC,MAAA,EAATJ,IAAA,GAAA,IAAAK,KAAA,CAAAY,KAAA,GAAAC,KAAA,GAAA,CAAA,EAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA,EAAA,EAAA;AAAAlB,UAAAA,IAAA,CAAAkB,KAAA,CAAA,GAAAf,SAAA,CAAAe,KAAA,CAAA;AAAA,QAAA;AACb1B,QAAAA,KAAA,CAAKG,UAAUY,IAAA,CAAK;AAAEP,UAAAA,IAAA,EAAAA,IAAA;AAAMF,UAAAA,IAAA,EAAM;AAAY,SAAC,CAAA;MACjD,CAAA;AACAqB,MAAAA,cAAA,EAAgB,SAAhBA,cAAAA,GAA6B;AAAA,QAAA,KAAA,IAAAC,KAAA,GAAAjB,SAAA,CAAAC,MAAA,EAATJ,IAAA,GAAA,IAAAK,KAAA,CAAAe,KAAA,GAAAC,KAAA,GAAA,CAAA,EAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA,EAAA,EAAA;AAAArB,UAAAA,IAAA,CAAAqB,KAAA,CAAA,GAAAlB,SAAA,CAAAkB,KAAA,CAAA;AAAA,QAAA;AAClB7B,QAAAA,KAAA,CAAKG,UAAUY,IAAA,CAAK;AAAEP,UAAAA,IAAA,EAAAA,IAAA;AAAMF,UAAAA,IAAA,EAAM;AAAiB,SAAC,CAAA;MACtD,CAAA;AACAwB,MAAAA,kBAAA,EAAoB,SAApBA,kBAAAA,GAAiC;AAAA,QAAA,KAAA,IAAAC,KAAA,GAAApB,SAAA,CAAAC,MAAA,EAATJ,IAAA,GAAA,IAAAK,KAAA,CAAAkB,KAAA,GAAAC,KAAA,GAAA,CAAA,EAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA,EAAA,EAAA;AAAAxB,UAAAA,IAAA,CAAAwB,KAAA,CAAA,GAAArB,SAAA,CAAAqB,KAAA,CAAA;AAAA,QAAA;AACtBhC,QAAAA,KAAA,CAAKG,UAAUY,IAAA,CAAK;AAAEP,UAAAA,IAAA,EAAAA,IAAA;AAAMF,UAAAA,IAAA,EAAM;AAAqB,SAAC,CAAA;MAC1D,CAAA;AACA2B,MAAAA,kBAAA,EAAoB,SAApBA,kBAAAA,GAAiC;AAAA,QAAA,KAAA,IAAAC,KAAA,GAAAvB,SAAA,CAAAC,MAAA,EAATJ,IAAA,GAAA,IAAAK,KAAA,CAAAqB,KAAA,GAAAC,KAAA,GAAA,CAAA,EAAAA,KAAA,GAAAD,KAAA,EAAAC,KAAA,EAAA,EAAA;AAAA3B,UAAAA,IAAA,CAAA2B,KAAA,CAAA,GAAAxB,SAAA,CAAAwB,KAAA,CAAA;AAAA,QAAA;AACtBnC,QAAAA,KAAA,CAAKG,UAAUY,IAAA,CAAK;AAAEP,UAAAA,IAAA,EAAAA,IAAA;AAAMF,UAAAA,IAAA,EAAM;AAAqB,SAAC,CAAA;MAC1D,CAAA;AACA8B,MAAAA,aAAA,EAAe,IAAA;AACfC,MAAAA,cAAA,EAAgB,IAAA;AAChBC,MAAAA,KAAA,EAAO,IAAA;MACPC,OAAOvC,KAAA,CAAKuC,KAAA;MACZC,kBAAkBxC,KAAA,CAAKwC;KACzB;EAAA,CAAA,CAAA;EAAAtC,eAAA,CAAA,IAAA,EAAA,kBAAA,EAE2B,UAACuC,GAAA,EAAsC;IAChE,IAAIA,QAAQ7C,SAAA,EAAW;MACrB,OAAO;AACL8C,QAAAA,OAAA,EAAS,SAATA,OAAAA,CAAUC,YAAA,EAAiB;UACzBC,MAAA,CAAOC,IAAA,CAAKF,YAAY,CAAA,CAAEvC,OAAA,CAAQ,UAACqC,IAAAA,EAAQ;AACzCzC,YAAAA,KAAA,CAAKyC,IAAG,CAAA,GAAIE,YAAA,CAAaF,IAAG,CAAA;AAC9B,UAAA,CAAC,CAAA;QACH,CAAA;QACAK,YAAY9C,KAAA,CAAK8C,UAAA;QACjBC,aAAa/C,KAAA,CAAK+C,WAAA;QAClBC,eAAehD,KAAA,CAAKgD,aAAA;QACpBC,YAAA,EAAc,SAAdA,YAAAA,GAAA;UAAA,OAAoBjD,KAAA,CAAKkD,SAAA;AAAA,QAAA,CAAA;AACzBC,QAAAA,YAAA,EAAc,SAAdA,YAAAA,CAAeZ,KAAA,EAAkB;UAC/BvC,KAAA,CAAKkD,SAAA,GAAYX,KAAA;AACnB,QAAA;OACF;AACF,IAAA;AAEAa,IAAAA,OAAA,CAAQC,IAAA,CACN,MAAA,EACA,iEACF,CAAA;AACA,IAAA,OAAO,IAAA;EACT,CAAA,CAAA;AAAAnD,EAAAA,eAAA,oBAEqC,EAAC,CAAA;EAAAA,eAAA,CAAA,IAAA,EAAA,eAAA,EAEkB,UAACoD,QAAA,EAAa;AACpEtD,IAAAA,KAAA,CAAKuD,SAAA,CAAUxC,KAAKuC,QAAQ,CAAA;AAE5B,IAAA,OAAO,YAAM;MACXtD,KAAA,CAAKuD,YAAYvD,KAAA,CAAKuD,SAAA,CAAUC,OAAO,UAACC,EAAA,EAAA;QAAA,OAAOA,OAAOH,QAAQ;MAAA,CAAA,CAAA;IAChE,CAAA;EACF,CAAA,CAAA;AAAApD,EAAAA,eAAA,sBAEsB,YAA6B;AAAA,IAAA,IAA5BwD,QAAA,GAAA/C,SAAA,CAAAC,MAAA,GAAA,CAAA,IAAAD,SAAA,CAAA,CAAA,CAAA,KAAAgD,SAAA,GAAAhD,SAAA,CAAA,CAAA,CAAA,GAAqB,EAAC;AAE3C,IAAA,IAAIX,KAAA,CAAKuD,UAAU3C,MAAA,EAAQ;AAAA,MAAA,IAAAgD,oBAAA;AAEzB,MAAA,IAAMC,MAAA,GAAA,CAAAD,oBAAA,GAAS5D,KAAA,CAAKqC,cAAA,MAAA,IAAA,IAAAuB,oBAAA,uBAALA,oBAAA,CAAAE,IAAA,CAAA9D,KAAA,EAAsB,CAAC0D,QAAQ,CAAC,CAAA;AAE/C1D,MAAAA,KAAA,CAAKuD,SAAA,CAAUnD,OAAA,CAAQ,UAACkD,QAAA,EAAa;AACnCA,QAAAA,QAAA,CAASO,QAAQH,QAAQ,CAAA;AAC3B,MAAA,CAAC,CAAA;AACH,IAAA;EACF,CAAA,CAAA;EAxFE,IAAA,CAAKK,eAAA,GAAkBhE,aAAA;AACzB,CAAA,CAAA;AA0FF,SAAwBiE,QAAQC,IAAA,EAA6B;AAC3D,EAAA,IAAMC,UAAUC,mBAAA,gBAA6BvB,MAAA,CAAOwB,MAAA,CAAO,EAAE,CAAC,CAAA;AAC9D,EAAA,IAAAC,SAAA,GAAwBC,qBAAA,CAAS,EAAE,CAAA;IAAAC,UAAA,GAAAC,cAAA,CAAAH,SAAA,EAAA,CAAA,CAAA;AAA1BI,IAAAA,WAAW,GAAAF,UAAA,CAAA,CAAA,CAAA;AAGpB,EAAA,IAAI,CAACL,OAAA,CAAQQ,OAAA,CAAQpC,KAAA,EAAO;AAC1B,IAAA,IAAI2B,IAAA,EAAM;MACRC,OAAA,CAAQQ,OAAA,GAAUT,IAAA;AAElBC,MAAAA,OAAA,CAAQQ,OAAA,CAAQnC,QAAQ,EAAC;AAC3B,IAAA,CAAA,MAAO;AAEL,MAAA,IAAMxC,gBAAgB,SAAhBA,gBAAsB;QAC1B0E,WAAA,CAAY,EAAE,CAAA;MAChB,CAAA;AAEA,MAAA,IAAME,SAAA,GAAuB,IAAI9E,SAAA,CAAUE,aAAa,CAAA;AAExDmE,MAAAA,OAAA,CAAQQ,OAAA,GAAUC,UAAUC,OAAA,EAAQ;AACtC,IAAA;AACF,EAAA;AAEA,EAAA,OAAO,CAACV,QAAQQ,OAAO,CAAA;AACzB;;;;"}