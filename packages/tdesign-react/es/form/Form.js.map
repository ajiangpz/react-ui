{"version":3,"file":"Form.js","sources":["../../../components/form/hooks/useWatch.ts","../../../components/form/Form.tsx"],"sourcesContent":["import { useState, useEffect, useMemo, useRef } from 'react';\nimport { get, isUndefined } from 'lodash-es';\nimport type { NamePath } from '../type';\nimport type { InternalFormInstance } from './interface';\nimport { HOOK_MARK } from './useForm';\nimport noop from '../../utils/noop';\n\nexport default function useWatch(name: NamePath, form: InternalFormInstance) {\n  const [value, setValue] = useState<any>();\n  const valueStr = useMemo(() => JSON.stringify(value), [value]);\n  const valueStrRef = useRef(valueStr);\n\n  // eslint-disable-next-line\n  const isValidForm = form && form._init;\n\n  useEffect(() => {\n    if (!isValidForm) return;\n\n    const { registerWatch = noop } = form.getInternalHooks?.(HOOK_MARK);\n\n    const cancelRegister = registerWatch(() => {\n      const allFieldsValue = form.getFieldsValue?.(true);\n      const newValue = get(allFieldsValue, name);\n      const nextValueStr = JSON.stringify(newValue);\n\n      // Compare stringify in case it's nest object\n      if (valueStrRef.current !== nextValueStr) {\n        valueStrRef.current = nextValueStr;\n        setValue(nextValueStr);\n      }\n    });\n\n    const allFieldsValue = form.getFieldsValue?.(true);\n    const initialValue = get(allFieldsValue, name);\n    setValue(JSON.stringify(initialValue));\n\n    return cancelRegister;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  return isUndefined(value) ? value : JSON.parse(value);\n}\n","import React, { useRef, useImperativeHandle } from 'react';\nimport classNames from 'classnames';\nimport useConfig from '../hooks/useConfig';\nimport noop from '../utils/noop';\nimport forwardRefWithStatics from '../utils/forwardRefWithStatics';\nimport type { TdFormProps } from './type';\nimport useInstance from './hooks/useInstance';\nimport useForm, { HOOK_MARK } from './hooks/useForm';\nimport useWatch from './hooks/useWatch';\nimport { StyledProps } from '../common';\n\nimport FormContext from './FormContext';\nimport FormItem from './FormItem';\nimport FormList from './FormList';\nimport { formDefaultProps } from './defaultProps';\nimport useDefaultProps from '../hooks/useDefaultProps';\n\nexport interface FormProps extends TdFormProps, StyledProps {\n    children?: React.ReactNode;\n}\n\nconst Form = forwardRefWithStatics((originalProps: FormProps, ref) => {\n    const { classPrefix, form: globalFormConfig } = useConfig();\n    const props = useDefaultProps<FormProps>(originalProps, formDefaultProps);\n    const {\n        style,\n        className,\n        labelWidth,\n        statusIcon,\n        labelAlign,\n        layout,\n        colon,\n        initialData,\n        requiredMark = globalFormConfig.requiredMark,\n        requiredMarkPosition = globalFormConfig.requiredMarkPosition,\n        scrollToFirstError,\n        showErrorMessage,\n        resetType,\n        rules,\n        errorMessage = globalFormConfig.errorMessage,\n        preventSubmitDefault,\n        disabled,\n        children,\n        id,\n        onReset,\n        onValuesChange = noop,\n    } = props;\n\n    const formClass = classNames(`${classPrefix}-form`, className, {\n        [`${classPrefix}-form-inline`]: layout === 'inline',\n    });\n\n    const [form] = useForm(props.form); // 内部与外部共享 form 实例，外部不传则内部创建\n    const formRef = useRef<HTMLFormElement>(null);\n    const formMapRef = useRef(new Map()); // 收集所有包含 name 属性 formItem 实例\n    const floatingFormDataRef = useRef({}); // 储存游离值的 formData\n    const formInstance = useInstance(props, formRef, formMapRef, floatingFormDataRef);\n\n    useImperativeHandle(ref, () => formInstance);\n    Object.assign(form, { ...formInstance });\n    form?.getInternalHooks?.(HOOK_MARK)?.setForm?.(formInstance);\n\n\n    // form 初始化后清空队列\n    React.useEffect(() => {\n        form?.getInternalHooks?.(HOOK_MARK)?.flashQueue?.();\n    }, [form]);\n\n    function onResetHandler(e: React.FormEvent<HTMLFormElement>) {\n        [...formMapRef.current.values()].forEach((formItemRef) => {\n            formItemRef?.current.resetField();\n        });\n        form?.getInternalHooks?.(HOOK_MARK)?.notifyWatch?.([]);\n        form.store = {};\n        onReset?.({ e });\n    }\n\n    function onFormItemValueChange(changedValue: Record<string, unknown>) {\n        const allFields = formInstance.getFieldsValue(true);\n        onValuesChange(changedValue, allFields);\n    }\n\n    function onKeyDownHandler(e: React.KeyboardEvent<HTMLFormElement>) {\n        // 禁用 input 输入框回车自动提交 form\n        if ((e.target as Element).tagName.toLowerCase() !== 'input') return;\n        if (preventSubmitDefault && e.key === 'Enter') {\n            e.preventDefault?.();\n            e.stopPropagation?.();\n        }\n    }\n\n    return (\n        <FormContext.Provider\n            value={{\n                form,\n                labelWidth,\n                statusIcon,\n                labelAlign,\n                layout,\n                colon,\n                initialData,\n                requiredMark,\n                requiredMarkPosition,\n                errorMessage,\n                showErrorMessage,\n                scrollToFirstError,\n                resetType,\n                rules,\n                disabled,\n                formMapRef,\n                floatingFormDataRef,\n                onFormItemValueChange,\n            }}\n        >\n            <form\n                ref={formRef}\n                id={id}\n                style={style}\n                className={formClass}\n                onSubmit={formInstance.submit}\n                onReset={onResetHandler}\n                onKeyDown={onKeyDownHandler}\n            >\n                {children}\n            </form>\n        </FormContext.Provider>\n    );\n\n\n}, { useForm, useWatch, FormItem, FormList });\n\nForm.displayName = 'Form';\n\nexport default Form;"],"names":["useWatch","name","form","_useState","useState","_useState2","_slicedToArray","value","setValue","valueStr","useMemo","JSON","stringify","valueStrRef","useRef","isValidForm","_init","useEffect","_form$getInternalHook3","_form$getFieldsValue2","_form$getInternalHook","getInternalHooks","call","HOOK_MARK","_form$getInternalHook2","registerWatch","noop","cancelRegister","_form$getFieldsValue","allFieldsValue","getFieldsValue","newValue","get","nextValueStr","current","initialValue","isUndefined","parse","Form","forwardRefWithStatics","originalProps","ref","_useConfig","useConfig","classPrefix","globalFormConfig","props","useDefaultProps","formDefaultProps","style","className","labelWidth","statusIcon","labelAlign","layout","colon","initialData","_props$requiredMark","requiredMark","_props$requiredMarkPo","requiredMarkPosition","scrollToFirstError","showErrorMessage","resetType","rules","_props$errorMessage","errorMessage","preventSubmitDefault","disabled","children","id","onReset","_props$onValuesChange","onValuesChange","formClass","classNames","concat","_defineProperty","_useForm","useForm","_useForm2","formRef","formMapRef","Map","floatingFormDataRef","formInstance","useInstance","useImperativeHandle","Object","assign","_objectSpread","setForm","React","_form$getInternalHook4","flashQueue","onResetHandler","e","_form$getInternalHook5","_form$getInternalHook6","_toConsumableArray","values","forEach","formItemRef","resetField","notifyWatch","store","onFormItemValueChange","changedValue","allFields","onKeyDownHandler","target","tagName","toLowerCase","key","_e$preventDefault","_e$stopPropagation","preventDefault","stopPropagation","createElement","FormContext","Provider","onSubmit","submit","onKeyDown","FormItem","FormList","displayName"],"mappings":"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"}