{"version":3,"file":"useDragSorter.js","sources":["../../../components/hooks/useEventCallback.ts","../../../components/hooks/useDragSorter.tsx"],"sourcesContent":["// https://github.com/scottrippey/react-use-event-hook/blob/75ba34af9175dc311afb3fb302d6fea44e4a5203/src/useEvent.ts\r\n// [RFC](https://github.com/reactjs/rfcs/blob/useevent/text/0000-useevent.md)\r\nimport React from 'react';\r\nimport noop from '../utils/noop';\r\n\r\ntype AnyFunction = (...args: unknown[]) => unknown;\r\n\r\n/**\r\n * Suppress the warning when using useLayoutEffect with SSR. (https://reactjs.org/link/uselayouteffect-ssr)\r\n * Make use of useInsertionEffect if available.\r\n */\r\nconst useInsertionEffect =\r\n  typeof window !== 'undefined'\r\n    ? React.useInsertionEffect || React.useLayoutEffect\r\n    : noop;\r\n\r\n/**\r\n * Render methods should be pure, especially when concurrency is used,\r\n * so we will throw this error if the callback is called while rendering.\r\n */\r\nfunction useEventCallbackShouldNotBeInvokedBeforeMount() {\r\n  throw new Error(\r\n    'INVALID_USEEVENTCALLBACK_INVOCATION: the callback from useEventCallback cannot be invoked before the component has mounted.',\r\n  );\r\n}\r\n\r\n/**\r\n * Similar to useCallback, with a few subtle differences:\r\n * - The returned function is a stable reference, and will always be the same between renders\r\n * - No dependency lists required\r\n * - Properties or state accessed within the callback will always be \"current\"\r\n */\r\nexport default function useEventCallback<TCallback extends AnyFunction>(\r\n  callback: TCallback,\r\n): TCallback {\r\n  // Keep track of the latest callback:\r\n  const latestRef = React.useRef<TCallback>(\r\n    useEventCallbackShouldNotBeInvokedBeforeMount as any,\r\n  );\r\n  useInsertionEffect(() => {\r\n    latestRef.current = callback;\r\n  }, [callback]);\r\n\r\n  // Create a stable callback that always calls the latest callback:\r\n  // using useRef instead of useCallback avoids creating and empty array on every render\r\n  const stableRef = React.useRef<TCallback>(null as any);\r\n  if (!stableRef.current) {\r\n    stableRef.current = function (this: unknown, ...args: unknown[]) {\r\n      return latestRef.current.apply(this, args);\r\n    } as TCallback;\r\n  }\r\n\r\n  return stableRef.current;\r\n}\r\n","import { useCallback, useState } from 'react';\r\nimport useEventCallback from './useEventCallback';\r\n\r\ninterface DragSortProps<T> {\r\n  sortOnDraggable: boolean;\r\n  onDragSort?: (context: DragSortContext<T>) => void;\r\n  onDragOverCheck?: {\r\n    x?: boolean;\r\n    targetClassNameRegExp?: RegExp;\r\n  };\r\n}\r\n\r\ntype DragFnType = (\r\n  e?: React.DragEvent<HTMLTableRowElement>,\r\n  index?: number,\r\n  record?: any,\r\n) => void;\r\ninterface DragSortInnerData {\r\n  dragging?: boolean;\r\n  draggable?: boolean;\r\n  onDragStart?: DragFnType;\r\n  onDragOver?: DragFnType;\r\n  onDrop?: DragFnType;\r\n  onDragEnd?: DragFnType;\r\n}\r\n\r\nexport interface DragSortInnerProps extends DragSortInnerData {\r\n  getDragProps?: (index?: number, record?: any) => DragSortInnerData;\r\n}\r\n\r\nexport interface DragSortContext<T> {\r\n  currentIndex: number;\r\n  current: T;\r\n  targetIndex: number;\r\n  target: T;\r\n}\r\n\r\nfunction useDragSorter<T>(props: DragSortProps<T>): DragSortInnerProps {\r\n  const { sortOnDraggable, onDragSort, onDragOverCheck } = props;\r\n  const [draggingIndex, setDraggingIndex] = useState(-1);\r\n  const [dragStartData, setDragStartData] = useState(null);\r\n  const [isDropped, setIsDropped] = useState(null);\r\n  const [startInfo, setStartInfo] = useState({\r\n    nodeX: 0,\r\n    nodeWidth: 0,\r\n    mouseX: 0,\r\n  });\r\n  const onDragSortEvent = useEventCallback(onDragSort as any);\r\n\r\n  const onDragOver = useCallback(\r\n    (e, index, record: T) => {\r\n      e.preventDefault();\r\n      if (draggingIndex === index || draggingIndex === -1) return;\r\n      if (\r\n        onDragOverCheck?.targetClassNameRegExp &&\r\n        !onDragOverCheck?.targetClassNameRegExp.test(e.target?.className)\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      if (onDragOverCheck?.x) {\r\n        if (!startInfo.nodeWidth) return;\r\n\r\n        const { x, width } = e.target.getBoundingClientRect();\r\n        const targetNodeMiddleX = x + width / 2;\r\n        const clientX = e.clientX || 0;\r\n        const draggingNodeLeft = clientX - (startInfo.mouseX - startInfo.nodeX);\r\n        const draggingNodeRight = draggingNodeLeft + startInfo.nodeWidth;\r\n\r\n        let overlap = false;\r\n        if (draggingNodeLeft > x && draggingNodeLeft < x + width) {\r\n          overlap = draggingNodeLeft < targetNodeMiddleX;\r\n        } else {\r\n          overlap = draggingNodeRight > targetNodeMiddleX;\r\n        }\r\n        if (!overlap) return;\r\n      }\r\n\r\n      onDragSortEvent({\r\n        currentIndex: draggingIndex,\r\n        current: dragStartData,\r\n        target: record,\r\n        targetIndex: index,\r\n      });\r\n      setDraggingIndex(index);\r\n    },\r\n    [\r\n      draggingIndex,\r\n      onDragOverCheck?.targetClassNameRegExp,\r\n      onDragOverCheck?.x,\r\n      dragStartData,\r\n      startInfo.nodeWidth,\r\n      startInfo.mouseX,\r\n      startInfo.nodeX,\r\n      onDragSortEvent,\r\n    ],\r\n  );\r\n\r\n  if (!sortOnDraggable) {\r\n    return {};\r\n  }\r\n\r\n  function onDragStart(e, index, record: T) {\r\n    setDraggingIndex(index);\r\n    setDragStartData(record);\r\n    if (onDragOverCheck) {\r\n      const { x, width } = e.target.getBoundingClientRect();\r\n      setStartInfo({\r\n        nodeX: x,\r\n        nodeWidth: width,\r\n        mouseX: e.clientX || 0,\r\n      });\r\n    }\r\n  }\r\n\r\n  function onDrop() {\r\n    setIsDropped(true);\r\n  }\r\n  function onDragEnd() {\r\n    if (!isDropped) {\r\n      // 取消排序，待扩展 api，输出 dragStartData\r\n    }\r\n    setIsDropped(false);\r\n    setDraggingIndex(-1);\r\n    setDragStartData(null);\r\n  }\r\n  function getDragProps(index, record: T) {\r\n    if (sortOnDraggable) {\r\n      return {\r\n        draggable: true,\r\n        onDragStart: (e) => {\r\n          onDragStart(e, index, record);\r\n        },\r\n        onDragOver: (e) => {\r\n          onDragOver(e, index, record);\r\n        },\r\n        onDrop: () => {\r\n          onDrop();\r\n        },\r\n        onDragEnd: () => {\r\n          onDragEnd();\r\n        },\r\n      };\r\n    }\r\n    return {};\r\n  }\r\n\r\n  return {\r\n    onDragStart,\r\n    onDragOver,\r\n    onDrop,\r\n    onDragEnd,\r\n    getDragProps,\r\n    dragging: draggingIndex !== -1,\r\n  };\r\n}\r\n\r\nexport default useDragSorter;\r\n"],"names":["useInsertionEffect","window","React","useLayoutEffect","noop","useEventCallbackShouldNotBeInvokedBeforeMount","Error","useEventCallback","callback","latestRef","useRef","current","stableRef","_len","arguments","length","args","Array","_key","apply","useDragSorter","props","sortOnDraggable","onDragSort","onDragOverCheck","_useState","useState","_useState2","_slicedToArray","draggingIndex","setDraggingIndex","_useState3","_useState4","dragStartData","setDragStartData","_useState5","_useState6","isDropped","setIsDropped","_useState7","nodeX","nodeWidth","mouseX","_useState8","startInfo","setStartInfo","onDragSortEvent","onDragOver","useCallback","e","index","record","_e$target","preventDefault","targetClassNameRegExp","test","target","className","x","_e$target$getBounding","getBoundingClientRect","width","targetNodeMiddleX","clientX","draggingNodeLeft","draggingNodeRight","overlap","currentIndex","targetIndex","onDragStart","_e$target$getBounding2","onDrop","onDragEnd","getDragProps","draggable","dragging"],"mappings":";;;;AAAA;AACA;AAMA;AACA;AACA;AACA;AACA,IAAMA,kBAAkB,GACtB,OAAOC,MAAM,KAAK,WAAW,GACzBC,KAAK,CAACF,kBAAkB,IAAIE,KAAK,CAACC,eAAe,GACjDC,IAAI;;AAEV;AACA;AACA;AACA;AACA,SAASC,6CAA6CA,GAAG;AACvD,EAAA,MAAM,IAAIC,KAAK,CACb,6HACF,CAAC;AACH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACe,SAASC,gBAAgBA,CACtCC,QAAmB,EACR;AACX;AACA,EAAA,IAAMC,SAAS,GAAGP,KAAK,CAACQ,MAAM,CAC5BL,6CACF,CAAC;AACDL,EAAAA,kBAAkB,CAAC,YAAM;IACvBS,SAAS,CAACE,OAAO,GAAGH,QAAQ;AAC9B,EAAA,CAAC,EAAE,CAACA,QAAQ,CAAC,CAAC;;AAEd;AACA;AACA,EAAA,IAAMI,SAAS,GAAGV,KAAK,CAACQ,MAAM,CAAY,IAAW,CAAC;AACtD,EAAA,IAAI,CAACE,SAAS,CAACD,OAAO,EAAE;IACtBC,SAAS,CAACD,OAAO,GAAG,YAA6C;AAAA,MAAA,KAAA,IAAAE,IAAA,GAAAC,SAAA,CAAAC,MAAA,EAAjBC,IAAI,GAAA,IAAAC,KAAA,CAAAJ,IAAA,GAAAK,IAAA,GAAA,CAAA,EAAAA,IAAA,GAAAL,IAAA,EAAAK,IAAA,EAAA,EAAA;AAAJF,QAAAA,IAAI,CAAAE,IAAA,CAAA,GAAAJ,SAAA,CAAAI,IAAA,CAAA;AAAA,MAAA;MAClD,OAAOT,SAAS,CAACE,OAAO,CAACQ,KAAK,CAAC,IAAI,EAAEH,IAAI,CAAC;IAC5C,CAAc;AAChB,EAAA;EAEA,OAAOJ,SAAS,CAACD,OAAO;AAC1B;;AChBA,SAASS,aAAaA,CAAIC,KAAuB,EAAsB;AACrE,EAAA,IAAQC,eAAe,GAAkCD,KAAK,CAAtDC,eAAe;IAAEC,UAAU,GAAsBF,KAAK,CAArCE,UAAU;IAAEC,eAAe,GAAKH,KAAK,CAAzBG,eAAe;AACpD,EAAA,IAAAC,SAAA,GAA0CC,QAAQ,CAAC,CAAC,CAAC,CAAC;IAAAC,UAAA,GAAAC,cAAA,CAAAH,SAAA,EAAA,CAAA,CAAA;AAA/CI,IAAAA,aAAa,GAAAF,UAAA,CAAA,CAAA,CAAA;AAAEG,IAAAA,gBAAgB,GAAAH,UAAA,CAAA,CAAA,CAAA;AACtC,EAAA,IAAAI,UAAA,GAA0CL,QAAQ,CAAC,IAAI,CAAC;IAAAM,UAAA,GAAAJ,cAAA,CAAAG,UAAA,EAAA,CAAA,CAAA;AAAjDE,IAAAA,aAAa,GAAAD,UAAA,CAAA,CAAA,CAAA;AAAEE,IAAAA,gBAAgB,GAAAF,UAAA,CAAA,CAAA,CAAA;AACtC,EAAA,IAAAG,UAAA,GAAkCT,QAAQ,CAAC,IAAI,CAAC;IAAAU,UAAA,GAAAR,cAAA,CAAAO,UAAA,EAAA,CAAA,CAAA;AAAzCE,IAAAA,SAAS,GAAAD,UAAA,CAAA,CAAA,CAAA;AAAEE,IAAAA,YAAY,GAAAF,UAAA,CAAA,CAAA,CAAA;EAC9B,IAAAG,UAAA,GAAkCb,QAAQ,CAAC;AACzCc,MAAAA,KAAK,EAAE,CAAC;AACRC,MAAAA,SAAS,EAAE,CAAC;AACZC,MAAAA,MAAM,EAAE;AACV,KAAC,CAAC;IAAAC,UAAA,GAAAf,cAAA,CAAAW,UAAA,EAAA,CAAA,CAAA;AAJKK,IAAAA,SAAS,GAAAD,UAAA,CAAA,CAAA,CAAA;AAAEE,IAAAA,YAAY,GAAAF,UAAA,CAAA,CAAA,CAAA;AAK9B,EAAA,IAAMG,eAAe,GAAGvC,gBAAgB,CAACgB,UAAiB,CAAC;EAE3D,IAAMwB,WAAU,GAAGC,WAAW,CAC5B,UAACC,CAAC,EAAEC,KAAK,EAAEC,MAAS,EAAK;AAAA,IAAA,IAAAC,SAAA;IACvBH,CAAC,CAACI,cAAc,EAAE;IAClB,IAAIxB,aAAa,KAAKqB,KAAK,IAAIrB,aAAa,KAAK,CAAC,CAAC,EAAE;AACrD,IAAA,IACEL,eAAe,KAAA,IAAA,IAAfA,eAAe,KAAA,KAAA,CAAA,IAAfA,eAAe,CAAE8B,qBAAqB,IACtC,EAAC9B,eAAe,KAAA,IAAA,IAAfA,eAAe,eAAfA,eAAe,CAAE8B,qBAAqB,CAACC,IAAI,CAAA,CAAAH,SAAA,GAACH,CAAC,CAACO,MAAM,MAAA,IAAA,IAAAJ,SAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAARA,SAAA,CAAUK,SAAS,CAAC,CAAA,EACjE;AACA,MAAA;AACF,IAAA;AAEA,IAAA,IAAIjC,eAAe,KAAA,IAAA,IAAfA,eAAe,eAAfA,eAAe,CAAEkC,CAAC,EAAE;AACtB,MAAA,IAAI,CAACd,SAAS,CAACH,SAAS,EAAE;MAE1B,IAAAkB,qBAAA,GAAqBV,CAAC,CAACO,MAAM,CAACI,qBAAqB,EAAE;QAA7CF,CAAC,GAAAC,qBAAA,CAADD,CAAC;QAAEG,KAAK,GAAAF,qBAAA,CAALE,KAAK;AAChB,MAAA,IAAMC,iBAAiB,GAAGJ,CAAC,GAAGG,KAAK,GAAG,CAAC;AACvC,MAAA,IAAME,OAAO,GAAGd,CAAC,CAACc,OAAO,IAAI,CAAC;MAC9B,IAAMC,gBAAgB,GAAGD,OAAO,IAAInB,SAAS,CAACF,MAAM,GAAGE,SAAS,CAACJ,KAAK,CAAC;AACvE,MAAA,IAAMyB,iBAAiB,GAAGD,gBAAgB,GAAGpB,SAAS,CAACH,SAAS;MAEhE,IAAIyB,OAAO,GAAG,KAAK;MACnB,IAAIF,gBAAgB,GAAGN,CAAC,IAAIM,gBAAgB,GAAGN,CAAC,GAAGG,KAAK,EAAE;QACxDK,OAAO,GAAGF,gBAAgB,GAAGF,iBAAiB;AAChD,MAAA,CAAC,MAAM;QACLI,OAAO,GAAGD,iBAAiB,GAAGH,iBAAiB;AACjD,MAAA;MACA,IAAI,CAACI,OAAO,EAAE;AAChB,IAAA;AAEApB,IAAAA,eAAe,CAAC;AACdqB,MAAAA,YAAY,EAAEtC,aAAa;AAC3BlB,MAAAA,OAAO,EAAEsB,aAAa;AACtBuB,MAAAA,MAAM,EAAEL,MAAM;AACdiB,MAAAA,WAAW,EAAElB;AACf,KAAC,CAAC;IACFpB,gBAAgB,CAACoB,KAAK,CAAC;AACzB,EAAA,CAAC,EACD,CACErB,aAAa,EACbL,eAAe,aAAfA,eAAe,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAfA,eAAe,CAAE8B,qBAAqB,EACtC9B,eAAe,KAAA,IAAA,IAAfA,eAAe,uBAAfA,eAAe,CAAEkC,CAAC,EAClBzB,aAAa,EACbW,SAAS,CAACH,SAAS,EACnBG,SAAS,CAACF,MAAM,EAChBE,SAAS,CAACJ,KAAK,EACfM,eAAe,CAEnB,CAAC;EAED,IAAI,CAACxB,eAAe,EAAE;AACpB,IAAA,OAAO,EAAE;AACX,EAAA;AAEA,EAAA,SAAS+C,YAAWA,CAACpB,CAAC,EAAEC,KAAK,EAAEC,MAAS,EAAE;IACxCrB,gBAAgB,CAACoB,KAAK,CAAC;IACvBhB,gBAAgB,CAACiB,MAAM,CAAC;AACxB,IAAA,IAAI3B,eAAe,EAAE;MACnB,IAAA8C,sBAAA,GAAqBrB,CAAC,CAACO,MAAM,CAACI,qBAAqB,EAAE;QAA7CF,CAAC,GAAAY,sBAAA,CAADZ,CAAC;QAAEG,KAAK,GAAAS,sBAAA,CAALT,KAAK;AAChBhB,MAAAA,YAAY,CAAC;AACXL,QAAAA,KAAK,EAAEkB,CAAC;AACRjB,QAAAA,SAAS,EAAEoB,KAAK;AAChBnB,QAAAA,MAAM,EAAEO,CAAC,CAACc,OAAO,IAAI;AACvB,OAAC,CAAC;AACJ,IAAA;AACF,EAAA;EAEA,SAASQ,OAAMA,GAAG;IAChBjC,YAAY,CAAC,IAAI,CAAC;AACpB,EAAA;EACA,SAASkC,UAASA,GAAG;IACnB,IAAI,CAACnC,SAAS,EAAE;AACd;AAAA,IAAA;IAEFC,YAAY,CAAC,KAAK,CAAC;IACnBR,gBAAgB,CAAC,CAAC,CAAC,CAAC;IACpBI,gBAAgB,CAAC,IAAI,CAAC;AACxB,EAAA;AACA,EAAA,SAASuC,YAAYA,CAACvB,KAAK,EAAEC,MAAS,EAAE;AACtC,IAAA,IAAI7B,eAAe,EAAE;MACnB,OAAO;AACLoD,QAAAA,SAAS,EAAE,IAAI;AACfL,QAAAA,WAAW,EAAE,SAAbA,WAAWA,CAAGpB,CAAC,EAAK;AAClBoB,UAAAA,YAAW,CAACpB,CAAC,EAAEC,KAAK,EAAEC,MAAM,CAAC;QAC/B,CAAC;AACDJ,QAAAA,UAAU,EAAE,SAAZA,UAAUA,CAAGE,CAAC,EAAK;AACjBF,UAAAA,WAAU,CAACE,CAAC,EAAEC,KAAK,EAAEC,MAAM,CAAC;QAC9B,CAAC;AACDoB,QAAAA,MAAM,EAAE,SAARA,MAAMA,GAAQ;AACZA,UAAAA,OAAM,EAAE;QACV,CAAC;AACDC,QAAAA,SAAS,EAAE,SAAXA,SAASA,GAAQ;AACfA,UAAAA,UAAS,EAAE;AACb,QAAA;OACD;AACH,IAAA;AACA,IAAA,OAAO,EAAE;AACX,EAAA;EAEA,OAAO;AACLH,IAAAA,WAAW,EAAXA,YAAW;AACXtB,IAAAA,UAAU,EAAVA,WAAU;AACVwB,IAAAA,MAAM,EAANA,OAAM;AACNC,IAAAA,SAAS,EAATA,UAAS;AACTC,IAAAA,YAAY,EAAZA,YAAY;IACZE,QAAQ,EAAE9C,aAAa,KAAK,CAAC;GAC9B;AACH;;;;"}